{% extends 'base.html' %}

{% block styles %}
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: #f0f0f0;
    text-align: center;
}

#gifts-container {
    position: relative;
    width: 100%;
    height: 600px;
    margin-top: 20px;
}

.gift-box {
    width: 80px;
    height: 80px;
    cursor: pointer;
    transition: transform 0.2s;
    position: absolute;
}

.gift-box:hover {
    transform: scale(1.1);
}

#remaining {
    margin-top: 20px;
    font-size: 18px;
    font-weight: bold;
}

.modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    z-index: 100;
}

.modal img {
    width: 100px;
    height: 100px;
    display: block;
    margin: 10px auto;
}

.modal button {
    margin-top: 10px;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    background: #007AFF;
    color: white;
    cursor: pointer;
}
</style>
{% endblock %}

{% block content %}
<h1>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏ üéÅ</h1>
<button onclick="restoreGifts()" id="restore-btn" style="padding: 10px 15px; margin-top: 15px; border: none; border-radius: 6px; background-color: #FF3B30; color: white; cursor: pointer;">
    –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏
</button>
<div id="gifts-container"></div>

<div id="modal" class="modal">
    <div id="modal-text"></div>
    <img id="modal-img" src="" alt="Gift">
    <button onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
{% endblock %}

{% block script %}
<script>
let gifts = [];


async function fetchGifts() {
    const res = await fetch('/lab9/api/gifts');
    gifts = await res.json();
    renderGifts();
    updateRemaining();
}

async function restoreGifts() {
    const res = await fetch('/lab9/api/gifts/restore', {
        method: 'POST'
    });

    if (res.ok) {
        await fetchGifts(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ gifts
    } else {
        console.error('Failed to restore gifts');
    }
}

function renderGifts() {
    const container = document.getElementById('gifts-container');
    container.innerHTML = '';
    
    gifts.forEach((gift, index) => {
        const box = document.createElement('img');
        box.src = 'https://cdn.jsdelivr.net/npm/emoji-datasource-apple/img/apple/64/1f381.png'; // –∫–æ—Ä–æ–±–∫–∞
        box.className = 'gift-box';
        // —Å–ª—É—á–∞–π–Ω—ã–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
        box.style.left = (20 + index * 100) + 'px';
        box.style.top = (50 + (index % 3) * 150) + 'px';
        box.dataset.id = gift.id;
        box.dataset.opened = gift.opened ? '1' : '0';

        box.addEventListener('click', async () => {
            if (box.dataset.opened === '1') return;



            const res = await fetch(`/lab9/api/gifts/open/${gift.id}`, { method: 'POST' });
            if (!res.ok) {
                const err = await res.json();
                alert(err.error);
                return;
            }
            const data = await res.json();

            // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–¥–∞—Ä–æ–∫
            showModal(data.congrats, data.url_photo);

            box.dataset.opened = '1';
            updateRemaining();
        });

        container.appendChild(box);
    });
}


function showModal(text, img) {
    document.getElementById('modal-text').textContent = text;
    document.getElementById('modal-img').src = img;
    document.getElementById('modal').style.display = 'block';
}

function closeModal() {
    document.getElementById('modal').style.display = 'none';
}


fetchGifts();
</script>
{% endblock %}